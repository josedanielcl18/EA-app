<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Weeks - EA Predictor</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles_final.css">
</head>
<body class="bg-dark text-white">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="index.html">EA Predictor</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="leaderboard.html">Leaderboard</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="game_weeks.html">Points <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="fixtures.html">Fixtures</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">Game Weeks</h1>
        <p class="text-center text-muted mb-4">Compare all players' scores across games by game week</p>

        <!-- Game Week Selector -->
        <div class="gameweek-selector text-center">
            <div id="gameweek-buttons">
                <p class="text-muted">Loading game weeks...</p>
            </div>
        </div>

        <!-- View Options -->
        <div class="view-options">
            <button class="toggle-predictions" id="toggle-predictions-btn" onclick="window.togglePredictions()">
                üëÅÔ∏è Show Predictions
            </button>
        </div>

        <!-- Results Matrix -->
        <div id="matrix-container">
            <p class="loading-message">Loading data...</p>
        </div>

        <!-- Legend -->
        <div id="legend-container" style="display: none;">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color perfect"></div>
                    <span>Perfect (10 pts)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color high"></div>
                    <span>High (7-9 pts)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color medium"></div>
                    <span>Medium (4-6 pts)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color low"></div>
                    <span>Low (1-3 pts)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color pending"></div>
                    <span>Pending</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { calculatePoints, calculatePlayerStats, getPlayerStats, getScoreClass } from "./js/calculations.js";
        import { firebaseConfig } from "./js/firebase-config.js";
        import { createPlayerHistoryModal, openPlayerHistory, setupPlayerClickHandlers } from "./js/ui-helpers.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Store user display names globally
        let userDisplayNamesGlobal = {};
        // Store overall player stats (totalPoints across all game weeks)
        let overallPlayerStats = {};

        // Create player history modal on page load
        createPlayerHistoryModal();

        // Setup global player click handler
        setupPlayerClickHandlers((userId) => {
            openPlayerHistory(userId, db, userDisplayNamesGlobal);
        });

        // Cloud Function URLs (commented out - using direct Firestore queries instead)
        // const CLOUD_FUNCTION_URL = {
        //     getGameWeekResults: 'http://localhost:5001/ea-football-predictor/us-central1/get_gameweek_results'
        // };

        // UI Elements
        const gameweekButtonsContainer = document.getElementById('gameweek-buttons');
        const matrixContainer = document.getElementById('matrix-container');
        const legendContainer = document.getElementById('legend-container');

        // State
        let selectedGameWeek = null;
        let gameWeeksList = [];
        let showPredictions = false;
        let allTeams = {};
        let currentMatrixGames = null;
        let currentMatrixPredictions = null;

        // Load available game weeks
        async function loadGameWeeks() {
            try {
                const gamesSnapshot = await getDocs(query(collection(db, 'games'), orderBy('KickOffTime', 'asc')));
                const gameWeekSet = new Set();
                
                gamesSnapshot.forEach(doc => {
                    const game = doc.data();
                    if (game.Fecha) {
                        gameWeekSet.add(game.Fecha);
                    }
                });

                gameWeeksList = Array.from(gameWeekSet).sort((a, b) => {
                    const numA = parseInt(a.replace('GW', ''));
                    const numB = parseInt(b.replace('GW', ''));
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.localeCompare(b);
                });

                // Load team logos
                const teamsSnapshot = await getDocs(collection(db, 'teams'));
                allTeams = {};
                teamsSnapshot.forEach(doc => {
                    allTeams[doc.data().name] = doc.data();
                });

                // Load overall player stats from ALL games
                await loadOverallPlayerStats(gamesSnapshot);

                if (gameWeeksList.length === 0) {
                    matrixContainer.innerHTML = '<p class="empty-message">No game weeks found.</p>';
                    return;
                }

                renderGameWeekButtons();
                selectGameWeek(gameWeeksList[gameWeeksList.length - 1]);

            } catch (error) {
                console.error("Error loading game weeks: ", error);
                matrixContainer.innerHTML = '<p class="empty-message" style="color: red;">Error loading game weeks. Please try again later.</p>';
            }
        }

        // Load overall player stats across all games
        async function loadOverallPlayerStats(allGamesSnapshot) {
            try {
                const allGames = [];
                allGamesSnapshot.forEach(doc => {
                    const gameData = doc.data();
                    gameData.id = doc.id;
                    allGames.push(gameData);
                });

                // Fetch ALL predictions
                const predictionsRef = collection(db, 'predictions');
                const allPredictions = [];
                const predSnapshot = await getDocs(predictionsRef);
                predSnapshot.forEach(doc => {
                    allPredictions.push(doc.data());
                });

                // Calculate overall stats using the calculations module
                overallPlayerStats = calculatePlayerStats(allGames, allPredictions);
            } catch (error) {
                console.error("Error loading overall player stats: ", error);
                overallPlayerStats = {};
            }
        }

        function renderGameWeekButtons() {
            gameweekButtonsContainer.innerHTML = gameWeeksList.map(gw => `
                <button class="btn btn-outline-secondary gameweek-button" onclick="window.selectGameWeek('${gw}')">
                    ${gw}
                </button>
            `).join('');
        }

        // Make selectGameWeek available globally
        window.selectGameWeek = selectGameWeek;

        function selectGameWeek(gameWeek) {
            selectedGameWeek = gameWeek;

            // Update active button
            document.querySelectorAll('.gameweek-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === gameWeek) {
                    btn.classList.add('active');
                }
            });

            // Load data from Cloud Function
            loadGameWeekResults();
        }

        window.togglePredictions = function() {
            showPredictions = !showPredictions;
            const btn = document.getElementById('toggle-predictions-btn');
            btn.textContent = showPredictions ? 'üëÅÔ∏è Hide Predictions' : 'üëÅÔ∏è Show Predictions';
            if (currentMatrixGames && currentMatrixPredictions) {
                renderMatrixWithData(currentMatrixGames, currentMatrixPredictions);
            }
        };

        // Check if any games in current game week have started (not upcoming)
        function hasStartedGames(games) {
            return games && games.some(game => game.status !== 'upcoming');
        }

        function renderMatrix() {
            if (currentMatrixGames && currentMatrixPredictions) {
                renderMatrixWithData(currentMatrixGames, currentMatrixPredictions);
            }
        }

        // Fetch results (currently local calculation, will use Cloud Function in production)
        async function loadGameWeekResults() {
            matrixContainer.innerHTML = '<p class="loading-message">Loading game week data...</p>';
            
            try {
                // Fetch games for this game week (without orderBy to avoid needing composite index)
                const gamesRef = collection(db, 'games');
                const gamesQuery = query(
                    gamesRef,
                    where('Fecha', '==', selectedGameWeek)
                );
                
                const gamesSnapshot = await getDocs(gamesQuery);
                let games = [];
                const gameMap = {};
                
                gamesSnapshot.forEach(doc => {
                    const gameData = doc.data();
                    gameData.id = doc.id;
                    games.push(gameData);
                    gameMap[doc.id] = gameData;
                });

                // Sort games by KickOffTime client-side
                games.sort((a, b) => {
                    const timeA = a.KickOffTime ? new Date(a.KickOffTime).getTime() : 0;
                    const timeB = b.KickOffTime ? new Date(b.KickOffTime).getTime() : 0;
                    return timeA - timeB;
                });

                if (games.length === 0) {
                    matrixContainer.innerHTML = '<p class="empty-message">No games found for this game week.</p>';
                    legendContainer.style.display = 'none';
                    return;
                }

                // Fetch all predictions for these games
                const predictionsRef = collection(db, 'predictions');
                const gameIds = games.map(g => g.id);
                
                const allPredictions = [];
                for (let i = 0; i < gameIds.length; i += 10) {
                    const batch = gameIds.slice(i, i + 10);
                    const predQuery = query(predictionsRef, where('gameId', 'in', batch));
                    const predSnapshot = await getDocs(predQuery);
                    predSnapshot.forEach(doc => {
                        allPredictions.push(doc.data());
                    });
                }

                // Calculate scores for each prediction
                const predictionsWithScores = [];
                allPredictions.forEach(pred => {
                    const game = gameMap[pred.gameId];
                    if (game) {
                        // Update display name mapping
                        if (pred.userId && pred.playerName) {
                            userDisplayNamesGlobal[pred.userId] = pred.playerName;
                        }

                        // Transform data to match our function signature
                        const gameForCalc = {
                            status: game.Status,
                            homeScore: game.HomeScore,
                            awayScore: game.AwayScore
                        };
                        
                        const points = calculatePoints(pred, gameForCalc);
                        predictionsWithScores.push({
                            userId: pred.userId || 'unknown',
                            playerName: pred.playerName || 'Unknown',
                            gameId: pred.gameId,
                            predictedHomeScore: pred.predictedHomeScore,
                            predictedAwayScore: pred.predictedAwayScore,
                            points: points,
                            gameStatus: game.Status
                        });
                    }
                });

                // Transform games to response format
                const gamesFormatted = games.map(game => ({
                    id: game.id,
                    homeTeam: game.HomeTeam,
                    awayTeam: game.AwayTeam,
                    homeScore: game.HomeScore,
                    awayScore: game.AwayScore,
                    status: game.Status,
                    kickOffTime: game.KickOffTime,
                    league: game.League
                }));

                // Store data for re-rendering when toggle predictions is clicked
                currentMatrixGames = gamesFormatted;
                currentMatrixPredictions = predictionsWithScores;

                // Reset predictions visibility if all games are still upcoming
                if (!hasStartedGames(gamesFormatted)) {
                    showPredictions = false;
                    document.getElementById('toggle-predictions-btn').textContent = 'üëÅÔ∏è Show Predictions';
                    document.getElementById('toggle-predictions-btn').disabled = true;
                    document.getElementById('toggle-predictions-btn').style.opacity = '0.5';
                    document.getElementById('toggle-predictions-btn').title = 'Predictions available after game starts';
                } else {
                    document.getElementById('toggle-predictions-btn').disabled = false;
                    document.getElementById('toggle-predictions-btn').style.opacity = '1';
                    document.getElementById('toggle-predictions-btn').title = '';
                }

                renderMatrixWithData(gamesFormatted, predictionsWithScores);

            } catch (error) {
                console.error("Error loading game week results: ", error);
                matrixContainer.innerHTML = `<p class="empty-message" style="color: red;">Error loading results: ${error.message}</p>`;
            }
        }

        function renderMatrixWithData(games, predictionsWithScores) {
            // Organize predictions by userId and game
            const matrixData = {};
            predictionsWithScores.forEach(pred => {
                const userId = pred.userId || 'unknown';
                if (!matrixData[userId]) {
                    matrixData[userId] = {};
                }
                matrixData[userId][pred.gameId] = {
                    points: pred.points,
                    prediction: pred
                };
            });

            // Get unique players and sort by Total GW (sum of points for current game week) in descending order
            const players = Object.keys(matrixData).sort((userIdA, userIdB) => {
                let totalA = 0;
                let totalB = 0;
                
                games.forEach(game => {
                    const dataA = matrixData[userIdA] && matrixData[userIdA][game.id];
                    const dataB = matrixData[userIdB] && matrixData[userIdB][game.id];
                    
                    if (dataA && dataA.points !== null) totalA += dataA.points;
                    if (dataB && dataB.points !== null) totalB += dataB.points;
                });
                
                return totalB - totalA; // Descending order
            });
            // Render HTML table
            let html = `
                <div class="results-matrix-container">
                    <table class="results-matrix">
                        <thead>
                            <tr>
                                <th class="player-name-cell">Player</th>
                                ${games.map(game => {
                                    const homeTeamData = allTeams[game.homeTeam] || {};
                                    const awayTeamData = allTeams[game.awayTeam] || {};
                                    const homeLogoUrl = homeTeamData.logoUrl || '';
                                    const awayLogoUrl = awayTeamData.logoUrl || '';
                                    
                                    // Format kick-off time
                                    let kickOffDisplay = '';
                                    if (game.kickOffTime) {
                                        const kickOffDate = new Date(game.kickOffTime);
                                        const dayName = kickOffDate.toLocaleDateString('en-US', { weekday: 'short' });
                                        const time = kickOffDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                                        kickOffDisplay = `${dayName} ${time}`;
                                    }
                                    
                                    return `
                                        <th class="game-header-cell">
                                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 2px; font-weight: 600;">${kickOffDisplay}</div>
                                            <div class="game-header-logos">
                                                ${homeLogoUrl ? `<div class="team-logo" style="background-image: url('${homeLogoUrl}');"></div>` : `<div style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.65rem; background-color: rgba(1, 157, 154, 0.4); border-radius: 50%; color: #3fc1c9; flex-shrink: 0;">${game.homeTeam.substring(0, 2).toUpperCase()}</div>`}
                                                <span style="font-size: 0.5rem; opacity: 0.4; margin: 0 1px;">-</span>
                                                ${awayLogoUrl ? `<div class="team-logo" style="background-image: url('${awayLogoUrl}');"></div>` : `<div style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.65rem; background-color: rgba(1, 157, 154, 0.4); border-radius: 50%; color: #3fc1c9; flex-shrink: 0;">${game.awayTeam.substring(0, 2).toUpperCase()}</div>`}
                                            </div>
                                            <div class="game-teams-text" title="${game.homeTeam} vs ${game.awayTeam}">
                                                ${game.homeTeam.substring(0, 3).toUpperCase()}<br/>${game.awayTeam.substring(0, 3).toUpperCase()}
                                            </div>
                                        </th>
                                    `;
                                }).join('')}
                                <th>Total GW</th>
                                <th>Total All</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Add player rows
            players.forEach(userId => {
                let playerTotal = 0;
                const displayName = userDisplayNamesGlobal[userId] || userId;
                html += `
                    <tr>
                        <td class="player-name-cell player-history-trigger" data-user-id="${userId}" style="cursor: pointer;" title="Click to view prediction history">${displayName}</td>
                `;

                games.forEach(game => {
                    const data = matrixData[userId] && matrixData[userId][game.id] ? matrixData[userId][game.id] : { points: null, prediction: null };
                    const points = data.points;
                    const prediction = data.prediction;
                    const scoreClass = getScoreClass(points);
                    const pointsDisplay = points === null ? '‚Äî' : points;

                    let scoreContent = pointsDisplay;
                    // Only show predictions if game has started (not upcoming) and predictions are toggled on
                    if (showPredictions && prediction && game.status !== 'upcoming') {
                        const pred = `${prediction.predictedHomeScore}-${prediction.predictedAwayScore}`;
                        const actual = game.status === 'finished' && game.homeScore !== null ? `${game.homeScore}-${game.awayScore}` : '?-?';
                        scoreContent = `
                            <div class="actual-score">${pointsDisplay}</div>
                            <div class="predicted-score">P: ${pred}<br/>A: ${actual}</div>
                        `;
                    }

                    html += `
                        <td class="score-cell ${scoreClass} ${showPredictions && prediction && game.status !== 'upcoming' ? 'with-prediction' : ''} tooltip-container">
                            ${showPredictions && prediction && game.status !== 'upcoming' ? scoreContent : pointsDisplay}
                            ${points !== null ? `<span class="tooltip-text">${points} points</span>` : ''}
                        </td>
                    `;

                    if (points !== null) {
                        playerTotal += points;
                    }
                });

                html += `
                    <td class="score-cell total-cell" style="background-color: #f5f5f5; font-weight: bold;">
                        ${playerTotal}
                    </td>
                    <td class="score-cell total-cell" style="background-color: #f5f5f5; font-weight: bold;">
                        ${overallPlayerStats[userId]?.totalPoints || 0}
                    </td>
                    </tr>
                `;
            });



            html += `
                        </tbody>
                    </table>
                </div>
            `;

            matrixContainer.innerHTML = html;
            legendContainer.style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadGameWeeks);
    </script>

</body>
</html>
